#!/bin/bash
set -e

REPO_GIT="https://github.com/yzeusy/BadVPN.git"
INSTALL_DIR="/etc/badvpn"

echo "ðŸ“¦ Instalando / Atualizando BadVPN"

# Garantir root
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Execute como root"
  exit 1
fi

# DependÃªncias
apt update -y >/dev/null 2>&1
apt install -y git wget >/dev/null 2>&1

# Parar serviÃ§o se existir
systemctl stop badvpn >/dev/null 2>&1 || true
systemctl disable badvpn >/dev/null 2>&1 || true

# Remover instalaÃ§Ãµes antigas
rm -rf /etc/badvpn
rm -f /usr/local/bin/badvpn
rm -f /usr/local/bin/badvpn-server
rm -f /usr/local/bin/badvpn-udpgw
rm -f /usr/local/bin/badvpn-tun2socks
rm -f /etc/systemd/system/badvpn.service
rm -rf /etc/systemd/system/badvpn.service.d

# Clonar repositÃ³rio NOVAMENTE
git clone "$REPO_GIT" "$INSTALL_DIR" >/dev/null 2>&1

cd "$INSTALL_DIR"

# Detectar arquitetura
ARCH=$(uname -m)
case "$ARCH" in
  x86_64) ARCH_DIR="amd64" ;;
  aarch64|arm64) ARCH_DIR="arm64" ;;
  *)
    echo "âŒ Arquitetura nÃ£o suportada: $ARCH"
    exit 1
    ;;
esac

echo "ðŸ§  Arquitetura detectada: $ARCH_DIR"

# Instalar binÃ¡rios (SUBSTITUI sem perguntar)
install -Dm755 bin/$ARCH_DIR/badvpn-server /usr/local/bin/badvpn-server
install -Dm755 bin/$ARCH_DIR/badvpn-udpgw /usr/local/bin/badvpn-udpgw
install -Dm755 bin/$ARCH_DIR/badvpn-tun2socks /usr/local/bin/badvpn-tun2socks

# Instalar comando Ãºnico
install -Dm755 badvpnctl /usr/local/bin/badvpn

# Instalar systemd
install -Dm644 badvpn.service /etc/systemd/system/badvpn.service

# Recarregar systemd
systemctl daemon-reexec
systemctl daemon-reload
sudo systemctl enable badvpn >/dev/null 2>&1

echo "âœ… BadVPN instalado / atualizado com sucesso!"
