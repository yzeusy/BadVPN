#!/bin/bash
set -e

REPO_GIT="https://github.com/yzeusy/BadVPN.git"
INSTALL_DIR="/etc/badvpn"

echo "üì¶ Instalando / Atualizando BadVPN"

# Garantir root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Execute como root"
  exit 1
fi

# Depend√™ncias
apt update -y >/dev/null 2>&1
apt install -y git wget >/dev/null 2>&1

# Parar servi√ßo se existir
systemctl stop badvpn >/dev/null 2>&1 || true
systemctl disable badvpn >/dev/null 2>&1 || true

# Remover instala√ß√µes antigas
rm -rf /etc/badvpn
rm -f /usr/local/bin/badvpn
rm -f /usr/local/bin/badvpn-server
rm -f /usr/local/bin/badvpn-udpgw
rm -f /usr/local/bin/badvpn-tun2socks
rm -f /etc/systemd/system/badvpn.service
rm -rf /etc/systemd/system/badvpn.service.d

# Clonar reposit√≥rio NOVAMENTE
git clone "$REPO_GIT" "$INSTALL_DIR" >/dev/null 2>&1

cd "$INSTALL_DIR"

# Detectar arquitetura
ARCH=$(uname -m)
case "$ARCH" in
  x86_64) ARCH_DIR="amd64" ;;
  aarch64|arm64) ARCH_DIR="arm64" ;;
  *)
    echo "‚ùå Arquitetura n√£o suportada: $ARCH"
    exit 1
    ;;
esac

echo "üß† Arquitetura detectada: $ARCH_DIR"

# Instalar bin√°rios (SUBSTITUI sem perguntar)
install -Dm755 bin/$ARCH_DIR/badvpn-server /usr/local/bin/badvpn-server
install -Dm755 bin/$ARCH_DIR/badvpn-udpgw /usr/local/bin/badvpn-udpgw
install -Dm755 bin/$ARCH_DIR/badvpn-tun2socks /usr/local/bin/badvpn-tun2socks

# Instalar comando √∫nico
install -Dm755 badvpnctl /usr/local/bin/badvpn

# Instalar systemd
install -Dm644 badvpn.service /etc/systemd/system/badvpn.service

# Recarregar systemd
systemctl daemon-reexec
systemctl daemon-reload

echo "‚úÖ BadVPN instalado / atualizado com sucesso!"
echo "üëâ Menu: sudo /etc/badvpn/badvpn-menu.sh"
echo "üëâ Comando: badvpn start | stop | status"
